FROM rust:1.83-bookworm AS rust-builder

WORKDIR /build
COPY Cargo.toml rust-toolchain.toml ./
COPY frost-lib/ frost-lib/
COPY frost-wasm/ frost-wasm/

RUN cargo test -p frost-lib
RUN cargo build --release -p frost-lib

FROM golang:1.22-bookworm

COPY --from=rust-builder /build/target/release/libfrostlib.so /usr/lib/
RUN ldconfig

WORKDIR /build
COPY go-frost/ go-frost/

COPY --from=rust-builder /build/frost-lib/include/frost-lib.h go-frost/includes/
RUN mkdir -p go-frost/includes/linux && \
    cp /usr/lib/libfrostlib.so go-frost/includes/linux/

WORKDIR /build/go-frost
RUN CGO_ENABLED=1 go test -v -count=1 ./...
